@{
    ViewBag.Title = "Chat";
    var chatUsers = ViewBag.ChatUsers as List<taskoreBusinessLogic.DBModel.UDBModel> ?? new List<taskoreBusinessLogic.DBModel.UDBModel>();
    var selectedUser = ViewBag.SelectedUser as taskoreBusinessLogic.DBModel.UDBModel;
    var messages = ViewBag.Messages as List<taskoreBusinessLogic.DBModel.ChatMessageDBModel> ?? new List<taskoreBusinessLogic.DBModel.ChatMessageDBModel>();
    int currentUserId = Session["UserId"] != null ? (int)Session["UserId"] : 0;
}

@Html.Partial("_Header")

<div class="main-content-container">
    <div class="chat-page-container">
        <div class="chat-sidebar">
            <h3>Chats</h3>
            <div class="chat-sidebar-divider"></div>
            <ul class="chat-user-list">
                @foreach (var user in chatUsers)
                {
                    <li class="chat-user-item @(selectedUser != null && user.Id == selectedUser.Id ? "active" : "")">
                        <a href="@Url.Action("Chat", "Main", new { userId = user.Id })">@user.FirstName @user.LastName</a>
                    </li>
                }
            </ul>
        </div>
        <div class="chat-main">
            <div class="chat-header">
                <h2>@(selectedUser != null ? ($"{selectedUser.FirstName} {selectedUser.LastName}") : "Select a chat")</h2>
            </div>
            <div class="chat-messages" id="chat-messages">
                @if (messages.Any())
                {
                    foreach (var msg in messages)
                    {
                        var isMine = msg.SenderId == currentUserId;
                        var userName = isMine ? "Me" : (selectedUser != null ? selectedUser.FirstName + " " + selectedUser.LastName : "");
                        <div class="chat-message @(isMine ? "mine" : "theirs")">
                            <span class="msg-text">@msg.Content</span>
                        </div>
                    }
                }
                else
                {
                    <div class="no-messages">No messages yet.</div>
                }
            </div>
            <form class="chat-input-form" action="@Url.Action("SendMessage", "Main")" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="ToUserId" value="@(selectedUser?.Id ?? 0)" />
                <div class="chat-input-row">
                    <input type="text" name="Message" class="chat-input" placeholder="Type your message..." autocomplete="off" required @(selectedUser == null ? "disabled" : "") />
                    <button type="submit" class="chat-send-btn" @(selectedUser == null ? "disabled" : "")>Send</button>
                </div>
            </form>
        </div>
    </div>
</div>

@Html.Partial("_Footer")

<style>
.main-content-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem 1rem;
}
.chat-page-container {
    display: flex;
    height: 85vh;
    background: #f8fafc;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    overflow: hidden;
    margin: 0 auto 1rem auto;
    max-width: 1200px;
}
.chat-sidebar {
    width: 280px;
    background: #fff;
    border-right: 1px solid #e2e8f0;
    padding: 1rem;
}
.chat-user-list {
    list-style: none;
    padding: 0;
    margin: 0;
}
.chat-user-item {
    margin-bottom: 0.5rem;
    padding: 0.7rem 1rem;
    border-radius: 6px;
    background: #fff;
    transition: background 0.2s;
}
.chat-user-item.active {
    background: #e5e7eb;
}
.chat-user-item:not(:last-child) {
    margin-bottom: 0.7rem;
}
.chat-user-item a {
    color: #334155;
    text-decoration: none;
    transition: color 0.2s;
    display: block;
}
.chat-user-item:hover {
    background: #f1f5f9;
    border-color: #bcd0ee;
}
.chat-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: #f8fafc;
}
.chat-header {
    padding: 1rem;
    border-bottom: 1px solid #e2e8f0;
    background: #fff;
}
.chat-messages {
    flex: 1;
    padding: 1rem;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}
.chat-message {
    padding: 0.5rem 1rem;
    border-radius: 16px;
    max-width: 60%;
    word-break: break-word;
    margin-bottom: 0.25rem;
}
.chat-message.mine {
    background: #3b82f6;
    color: #fff;
    align-self: flex-end;
}
.chat-message.theirs {
    background: #e2e8f0;
    color: #334155;
    align-self: flex-start;
}
.msg-user {
    font-weight: bold;
    margin-right: 0.5rem;
}
.chat-input-form {
    padding: 1rem;
    background: #fff;
    border-top: 1px solid #e2e8f0;
}
.chat-input-row {
    display: flex;
    gap: 0.5rem;
}
.chat-input {
    flex: 1;
    padding: 0.5rem 1rem;
    border: 1px solid #e2e8f0;
    border-radius: 20px;
    font-size: 1rem;
}
.chat-send-btn {
    background: #3b82f6;
    color: #fff;
    border: none;
    border-radius: 20px;
    padding: 0.5rem 1.5rem;
    font-size: 1rem;
    cursor: pointer;
    transition: background 0.2s;
}
.chat-send-btn:hover {
    background: #2563eb;
}
.no-messages {
    color: #64748b;
    text-align: center;
    margin-top: 2rem;
}
.chat-sidebar-divider {
    height: 1px;
    background: #e5e7eb;
    margin: 0.7rem 0 1.2rem 0;
    border: none;
}
</style> 